# Cilium eBPF uRetprobe Demo

This folder contains a demo showcasing the usage of uRetprobe with Cilium eBPF for Go applications.
This demo highlights potential issues and crashes when using uRetprobe with Go programs due to the intricacies of Go's runtime and function return handling.

## Table of Contents
1. [Directory Structure](#directory-structure)
2. [Running the Demo](#running-the-demo)
3. [Makefile Commands](#makefile-commands)
4. [Code Overview](#code-overview)
5. [Understanding the Crash](#understanding-the-crash)

## Directory Structure
```
uprobe-time/
├── server/           # Directory containing the Go application
│   └── server.go     # Go application source code
├── tracer/           # Directory containing the tracing application
│   ├── main.go       # Tracing application source code
│   ├── trace.c       # eBPF program source code
│   └── bpf_bpfel.go  # Generated Go code from eBPF program
│   └── bpf_bpfeb.go  # Generated Go code from eBPF program
├── Makefile          # Makefile for building and running the demo
└── README.md         # This README file
```

## Running the Demo
1.	Build the application and the tracer:
    ``make all``
2. Run the Go application:
   ``make run-app``
3. In a new terminal, run the tracer with sudo privileges:
   ``sudo make run-tracer``
4. Access the Go application with cURL:
   ``curl localhost:8091?arg=42``
5. Observe the tracer output in the terminal running the tracer.

## Makefile Commands
You can use `make help` to see all available commands.

## Code Overview

### Go Application
The Go application (`server/server.go`) is a simple HTTP server with one endpoint that accepts a query parameter arg and passes it to the demo function, which prints the value of arg.

### Tracing Application
The tracing application (`tracer/main.go`) sets up a uRetprobe to trace the `demo` function in the Go application. It uses a ring buffer to read events generated by the eBPF program.

### eBPF Program
The eBPF program (`tracer/trace.c`) defines the event structure and the uProbe function that reads the argument passed to the demo function and submits it to the ring buffer.

## Understanding the Crash
uRetprobes can crash Go programs due to several reasons:
1. **Inlining and Optimizations**: Go's compiler performs optimizations, including inlining. When a function is inlined, there is no clear return point to attach a uRetprobe, leading to unpredictable behavior if you try to attach a uRetprobe to such functions.
2. **Stack Traces and Return Addresses**: Go maintains its own stack frames and return addresses, which might not align with what the eBPF program expects. Attaching a uRetprobe could disrupt these stack frames, causing the program to crash when it attempts to unwind the stack or return to a corrupted address.

You can find more information about these issues in this: [GitHub issue](https://github.com/iovisor/bcc/issues/1320) and good description of what happens under the hood [here](https://github.com/golang/go/issues/22008#issuecomment-523237105).

To avoid these issues, consider using uProbes or other tracing mechanisms that are more compatible with Go's runtime and function handling.
